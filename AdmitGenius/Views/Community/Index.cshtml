@{
    ViewData["Title"] = "Chat Room";
}


<!-- This is an example component -->
<div class="container mx-auto shadow-lg rounded-lg">
    <!-- headaer 
    <div class="px-5 py-5 flex justify-between items-center bg-white border-b-2">
        <div class="font-semibold text-2xl">GoingChat</div>
        <div class="w-1/2">
            <input type="text"
                   name=""
                   id=""
                   placeholder="search IRL"
                   class="rounded-2xl bg-gray-100 py-3 px-5 w-full" />
        </div>
        <div class="h-12 w-12 p-2 bg-yellow-500 rounded-full text-white font-semibold flex items-center justify-center">
            RA
        </div>
    </div>
    end header -->
    <!-- Chatting -->
    <div class="flex flex-row justify-between bg-white" style="border-top: 0.5px solid #d2d2d2;    height: 90vh;">
        <!-- chat list -->
        <div style="    height: 90vh;    overflow-y: scroll;    width: 50%;" class="flex flex-col w-2/5 border-r-2 overflow-y-auto">

            <div style="text-align: center;margin-top: 10px;" class="font-semibold text-2xl">
                GoingChat
            </div>

            <!-- search compt -->
            <div class="border-b-2 py-4 px-2">
                <input type="text"
                       placeholder="search Community"
                       class="py-2 px-2 border-2 border-gray-200 rounded-2xl w-full" />
            </div>
            <!-- end search compt -->
            <!-- user list -->

            <style>
                .chatlist{
                    background-color: #859f0126;
                    border-radius: 20px;
                    margin: 10px;
                }
            </style>

            <a asp-controller="Community" asp-action="Index">

            <div s Class="chatlist flex flex-row py-4 px-2 justify-center items-center border-b-2">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/_7LbC5J-jw4/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div style="height: 50px;overflow: hidden;" class="w-full">
                    <div class="text-lg font-semibold">
                        Computer Engineers
                    </div>
                        <span class="text-gray-500">Which is the best place to learn DSA? &middot; 29 Mins</span>
                </div>
            </div>
            </a> <a asp-controller="Community" asp-action="Index">
                <div  class="chatlist flex flex-row py-4 px-2 items-center border-b-2">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/otT2199XwI8/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div class="w-full">
                    <div class="text-lg font-semibold">Android Studio newbies</div>
                        <span class="text-gray-500">Hi Sam, Welcome &middot; 2 hrs</span>
                </div>
            </div>
            </a> <a asp-controller="Community" asp-action="Index">
                <div style="border-color:#e9c800;" class="chatlist flex flex-row py-4 px-2 items-center border-b-2 border-l-4 border-blue-400">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/L2cxSuKWbpo/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div class="w-full" >
                    <div class="text-lg font-semibold">MERN Stack</div>
                    <span class="text-gray-500" id="lastMessageContainer"></span>
                </div>

            </div>
            </a> <a asp-controller="Community" asp-action="Index">
            <div class="chatlist flex flex-row py-4 px-2 items-center border-b-2">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/vpOeXr5wmR4/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div class="w-full">
                    <div class="text-lg font-semibold">Node Bugger</div>
                        <span class="text-gray-500">Evan : some one can fix this &middot; 1 hrs</span>
                </div>
            </div>
            </a> <a asp-controller="Community" asp-action="Index">
            <div class="chatlist flex flex-row py-4 px-2 items-center border-b-2">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/vpOeXr5wmR4/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div class="w-full">
                    <div class="text-lg font-semibold">Javascript Helpers</div>
                        <span class="text-gray-500">Evan : some one can fix this &middot; 20 Mins</span>
                </div>
            </div>
            </a> <a asp-controller="Community" asp-action="Index">
            <div class="chatlist flex flex-row py-4 px-2 items-center border-b-2">
                    <div style="    width: 18%;" class="w-1/4">
                    <img src="https://source.unsplash.com/vpOeXr5wmR4/600x600"
                         class="object-cover h-12 w-12 rounded-full"
                         alt="" />
                </div>
                <div class="w-full">
                    <div class="text-lg font-semibold">PHPs</div>
                        <span class="text-gray-500">Evan : some one can fix this &middot; 42 Mins</span>
                </div>
            </div>
            </a>
            <!-- end user list -->
        </div>
        <!-- end chat list -->
        <!-- message -->
        <div class="w-full flex flex-col" style="background-color:#f9f9f9">

            
            <div id="chat-box" style="height: 79vh;gap: 10px;justify-content: flex-start;overflow-y: scroll;" class="w-full px-5 flex flex-col justify-between">
                <div style="    display: flex;    margin: 20px;    align-items: center;    justify-content: center;">
                    You Joined on January 2022
                </div>
                <!--Message displayherhe-->

                
            </div>

            <form id="message-form" style="padding: 20px">

                <div style="box-shadow: 0px 0px 2px 2px #032c5a30; " class="flex flex-row items-center h-16 rounded-xl bg-white w-full px-4">
                    <div>
                        <button class="flex items-center justify-center text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                        </button>
                    </div>
                
                <div class="flex-grow ml-4">
                    
                        <div class="relative w-full">
                            <input type="text"
                                   id="message-input"
                                   class="flex w-full border rounded-xl focus:outline-none focus:border-indigo-300 pl-4 h-10" />
                            <button class="absolute flex items-center justify-center h-full w-12 right-0 top-0 text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6"
                                     fill="none"
                                     stroke="currentColor"
                                     viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round"
                                          stroke-linejoin="round"
                                          stroke-width="2"
                                          d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        </div>
                    
                </div>
                <div class="ml-4">
                        <button id="send-message-button" type="submit" style="background-color: #110070; padding-top: 7px; padding-bottom: 7px;" class="flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white px-4 py-1 flex-shrink-0">
                        <span>Send</span>
                        <span class="ml-2">
                            <svg class="w-4 h-4 transform rotate-45 -mt-px"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </span>
                    </button>
                    </div>
               
            </div>



            </form>
        </div> 
        <!-- end message -->
        <div class="w-2/5 border-l-2 px-5">
            <div class="flex flex-col">
                <div class="font-semibold text-xl py-4">Mern Stack Group</div>
                <img src="https://source.unsplash.com/L2cxSuKWbpo/600x600"
                     class="object-cover rounded-xl h-64"
                     alt="" />
                <div class="font-semibold py-4">Created 22 Sep 2021</div>
                <div class="font-light">
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Deserunt,
                    perspiciatis!
                </div>
            </div>
        </div>
    </div>
</div>



@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.9/signalr.min.js"></script>
    <script>
        $(function () {
            var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

            connection.start().catch(function (err) {
                return console.error(err.toString());
            });

            var lastMessage = "";

            connection.on("ReceiveMessage", function (sender, message, userProfile) {


                // Format the new message and append it to the chat box
                var formattedMessage = `
               
                <div class="flex items-start gap-2.5" style="border-left: 3px solid #f6ff0073;">
                    <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl dark:bg-gray-700" style="background: transparent;">
                        <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                        <img style="object-fit: cover;" class="w-8 h-8 rounded-full" src="${userProfile}" alt="${sender} image">
                            <div>
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">${sender}</span>
                                <span class="text-sm font-normal text-gray-500 dark:text-gray-400">${formatTime(new Date())}</span>
                            </div>
                        </div>
                        <p class="text-sm font-normal py-2.5 text-gray-900 dark:text-white">${message}</p>
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Delivered</span>
                    </div>
                    <div class="relative inline-block text-left">
                        <button id="dropdownMenuIconButton" data-dropdown-toggle="dropdownDots" data-dropdown-placement="bottom-start" class="inline-flex self-center items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-600" type="button">
                            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
                                <path d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"></path>
                            </svg>
                        </button>
                        <div id="dropdownDots" class="z-10 bg-white divide-y divide-gray-100 rounded-lg shadow w-40 dark:bg-gray-700 dark:divide-gray-600 hidden" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(1129.6px, 232.8px, 0px);" data-popper-placement="bottom-start">
                            <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
                                <li>
                                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Reply</a>
                                </li>
                                <li>
                                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Forward</a>
                                </li>
                                <li>
                                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Copy</a>
                                </li>
                                <li>
                                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Report</a>
                                </li>
                                <li>
                                    <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Delete</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>`;

                

                $('#chat-box').append(formattedMessage);

                time = formatTimeDifference(new Date())

                document.getElementById("lastMessageContainer").innerHTML = `${sender} : ${message} &middot; ${time}`;
            });

            connection.on("ChatHistory", function (history) {

                

                // Append historical messages to the chat box
                for (var i = 0; i < history.length; i++) {

                    var randomColor = getRandomColor();

                    var formattedMessage = `
                      <div class="flex items-start gap-2.5" style="border-left: 3px solid ${randomColor};">
                        <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl dark:bg-gray-700" style="background: transparent;">
                            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                     <img  style="object-fit: cover;" class="w-8 h-8 rounded-full" src="${history[i].userProfile}" alt="${history[i].sender} image">
                                <div>
                                    <span class="text-sm font-semibold text-gray-900 dark:text-white">${history[i].sender}</span>
                                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">${formatTime(new Date(history[i].timestamp))}</span>
                                </div>
                            </div>
                            <p class="text-sm font-normal py-2.5 text-gray-900 dark:text-white">${history[i].message}</p>
                            <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Delivered</span>
                        </div>
                        <div class="relative inline-block text-left">
                            <button id="dropdownMenuIconButton" data-dropdown-toggle="dropdownDots" data-dropdown-placement="bottom-start" class="inline-flex self-center items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-600" type="button">
                                <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
                                    <path d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"></path>
                                </svg>
                            </button>
                            <div id="dropdownDots" class="z-10 bg-white divide-y divide-gray-100 rounded-lg shadow w-40 dark:bg-gray-700 dark:divide-gray-600 hidden" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(1129.6px, 232.8px, 0px);" data-popper-placement="bottom-start">
                                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
                                    <li>
                                        <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Reply</a>
                                    </li>
                                    <li>
                                        <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Forward</a>
                                    </li>
                                    <li>
                                        <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Copy</a>
                                    </li>
                                    <li>
                                        <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Report</a>
                                    </li>
                                    <li>
                                        <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Delete</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>`;

                    $('#chat-box').append(formattedMessage);

                    if (history.length > 0) {

                        lastMessage = history[history.length - 1].message;
                        time = formatTimeDifference(history[history.length - 1].timestamp);
                        sender = history[history.length - 1].sender

                        document.getElementById("lastMessageContainer").innerHTML = ` ${sender} : ${lastMessage} &middot; ${time}`;
                    }

                }

                function getRandomColor() {
                    var letters = '0123456789ABCDEF';
                    var color = '#';
                    for (var i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }
            });


            function formatTimeDifference(timeInDatabase) {
                const currentTime = new Date();
                const databaseTime = new Date(timeInDatabase);

                const timeDifferenceInSeconds = Math.floor((currentTime - databaseTime) / 1000);

               // if (timeDifferenceInSeconds < 60) {
               //     return `${timeDifferenceInSeconds} s`;
               // }

                const timeDifferenceInMinutes = Math.floor(timeDifferenceInSeconds / 60);

                if (timeDifferenceInMinutes < 60) {
                    return `${timeDifferenceInMinutes} mins`;
                }

                const timeDifferenceInHours = Math.floor(timeDifferenceInMinutes / 60);

                if (timeDifferenceInHours < 24) {
                    return `${timeDifferenceInHours} hrs`;
                }

                const timeDifferenceInDays = Math.floor(timeDifferenceInHours / 24);
                return `${timeDifferenceInDays} days`;
            }


            function formatTime(date) {
                // Format time differently for received messages and historical messages
                var hours = date.getHours();
                var minutes = date.getMinutes();
                var ampm = hours >= 12 ? 'PM' : 'AM';

                if (hours > 12) {
                    hours = hours - 12;
                }

                return `${hours}:${minutes} ${ampm}`;
            }


            // Submit the message form
            $('#message-form').submit(function (event) {
                event.preventDefault();
                var message = $('#message-input').val();
                if (message.trim() !== '') {
                    // Send the message to the server
                    connection.invoke("SendMessage", '@ViewBag.UserName', message).catch(function (err) {
                        return console.error(err.toString());
                    });
                }
                $('#message-input').val('');
            });
        });
    </script>
}
